# 实现计划: Claude Code 完整复刻

## 概述

本实现计划将 Claude Code 的完整功能分解为可执行的编码任务。我们将使用 TypeScript 和 `@anthropic-ai/claude-agent-sdk` (v1.x) 构建一个功能完整的命令行工具。

实现策略：
- 采用增量开发方式，每个任务都可独立验证
- 优先实现核心功能，然后逐步添加扩展功能
- 每个主要模块完成后设置检查点
- 测试任务标记为可选，可根据需要调整

## 任务列表

### 阶段 1: 项目基础设施

- [x] 1. 初始化项目结构和依赖
  - 创建 TypeScript 项目配置 (tsconfig.json)
  - 安装核心依赖: `@anthropic-ai/claude-agent-sdk@^0.1.76`, TypeScript 5.9+, Node.js 类型定义
  - 配置 ESLint 和 Prettier
  - 创建基本目录结构: `src/`, `tests/`, `dist/`
  - 配置 package.json 的 scripts 和 bin 入口
  - _需求: 所有需求的基础_

- [x] 1.1 配置测试框架
  - 安装 Jest 30+ 和 fast-check 3.0+
  - 配置 Jest 支持 TypeScript
  - 创建测试工具函数和 fixtures
  - _需求: 所有需求的测试基础_

### 阶段 2: 核心 SDK 集成层

- [x] 2. 实现 SDK 配置加载器 (SDKConfigLoader)
  - 实现 `loadUserConfig()` 方法读取 ~/.claude/settings.json
  - 实现 `loadProjectConfig()` 方法读取 .claude/settings.json
  - 实现 `mergeConfigs()` 方法合并配置（项目覆盖用户）
  - 实现 `loadClaudeMd()` 方法读取 CLAUDE.md 文件
  - 实现 `buildOptionsWithSettingSources()` 构建 SDK Options
  - _需求: 7.1, 7.2, 7.3, 18.4_

- [x] 2.1 为配置加载器编写属性测试
  - **属性 1: 配置合并的优先级**
  - **验证: 需求 7.3**

- [x] 3. 实现工具注册表 (ToolRegistry)
  - 实现 `getDefaultTools()` 返回默认工具列表
  - 实现 `getAllTools()` 返回所有可用工具
  - 实现 `getEnabledTools()` 根据配置返回启用的工具
  - 实现 `isValidTool()` 验证工具名称
  - _需求: 2.1, 2.2, 2.3, 3.1, 4.1, 4.2, 4.3_

- [x] 3.1 为工具注册表编写单元测试
  - 测试默认工具列表
  - 测试工具启用/禁用逻辑
  - 测试工具名称验证
  - _需求: 2.1, 3.1, 4.1_

- [x] 4. 实现权限管理器 (PermissionManager)
  - 实现 `createCanUseToolHandler()` 创建 SDK 兼容的权限函数
  - 实现 `shouldPromptForTool()` 判断是否需要用户确认
  - 实现 `promptUser()` 请求用户确认
  - 实现 `setMode()` 运行时修改权限模式
  - 实现白名单和黑名单管理方法
  - _需求: 14.1, 14.2, 14.3, 14.4, 14.5_

- [x] 4.1 为权限管理器编写属性测试
  - **属性 4: 工具权限的安全性**
  - **验证: 需求 14.1, 14.3**

### 阶段 3: 会话管理

- [x] 5. 实现会话管理器 (SessionManager)
  - 实现 `createSession()` 创建新会话
  - 实现 `loadSession()` 加载已保存的会话
  - 实现 `saveSession()` 保存会话状态
  - 实现 `listSessions()` 列出所有会话
  - 实现 `cleanSessions()` 清理过期会话
  - 实现 `getRecentSession()` 获取最近的会话
  - 创建会话存储目录结构 (~/.claude-replica/sessions/)
  - _需求: 6.1, 6.2, 6.3, 6.4, 6.5, 6.6_

- [x] 5.1 为会话管理器编写属性测试
  - **属性 2: 会话恢复的完整性**
  - **验证: 需求 6.3, 6.4**

- [x] 5.2 为会话管理器编写属性测试
  - **属性 11: 会话过期的时效性**
  - **验证: 需求 6.5**

### 阶段 4: 消息路由和 SDK 集成

- [x] 6. 实现消息路由器 (MessageRouter)
  - 实现 `routeMessage()` 方法，使用 `query()` 函数处理消息
  - 实现 `buildSystemPrompt()` 构建系统提示词（包含 CLAUDE.md 和技能）
  - 实现 `getEnabledToolNames()` 获取启用的工具列表
  - 实现 `createPermissionHandler()` 创建权限处理函数
  - 实现 `getAgentDefinitions()` 获取子代理定义
  - 处理 `query()` 返回的 `Query` 对象
  - _需求: 1.4, 8.3, 10.4, 18.1, 18.2, 18.3, 18.5_

- [x] 6.1 为消息路由器编写单元测试
  - 测试 `query()` 函数的调用（使用对象参数）
  - 测试 Options 接口的构建
  - 测试系统提示词的构建
  - _需求: 1.4, 18.5_

- [x] 7. 实现流式消息处理器
  - 实现处理 `SDKMessage` 类型的不同消息类型
  - 实现 `assistant` 消息的文本提取和显示
  - 实现 `tool_use` 消息的工具调用显示
  - 实现 `result` 消息的结果处理
  - 实现流式输出到终端
  - _需求: 1.4, 17.4_

- [x] 7.1 为流式消息处理器编写单元测试
  - 测试不同 SDKMessage 类型的处理
  - 测试流式输出逻辑
  - _需求: 1.4_

### 阶段 5: CLI 接口

- [x] 8. 实现 CLI 参数解析器 (CLIParser)
  - 实现基本选项解析: -p, -c, --resume, --help, --version
  - 实现模型选择: --model
  - 实现工具控制: --allowed-tools, --disallowed-tools
  - 实现权限模式: --permission-mode, --dangerously-skip-permissions
  - 实现输出格式: --output-format, --verbose
  - 实现扩展选项: --agents, --plugin-dir, --setting-sources
  - 实现高级选项: --max-turns, --max-budget-usd, --sandbox
  - _需求: 1.1, 1.2, 1.3, 14.4, 17.1, 17.2, 17.3, 19.1, 19.2, 19.3_

- [x] 8.1 为 CLI 解析器编写单元测试
  - 测试各种命令行参数组合
  - 测试参数验证和错误处理
  - _需求: 1.1, 1.2, 1.3_

- [x] 9. 实现交互式 UI (InteractiveUI)
  - 实现 `start()` 启动交互式会话
  - 实现 `displayMessage()` 显示消息（用户/助手）
  - 实现 `displayToolUse()` 显示工具调用
  - 实现 `displayProgress()` 显示进度指示器
  - 实现 `promptConfirmation()` 请求用户确认
  - 实现 `showRewindMenu()` 显示回退菜单
  - 实现 Esc 键中断功能
  - 实现 Esc + Esc 打开回退菜单
  - _需求: 1.4, 1.5, 1.6, 15.2, 27.1, 27.2, 27.3, 27.4, 27.5_

- [x] 9.1 为交互式 UI 编写单元测试
  - 测试消息显示格式
  - 测试用户输入处理
  - 测试中断和回退功能
  - _需求: 1.5, 1.6, 15.2_

### 阶段 6: 扩展系统 - 技能

- [x] 10. 实现技能管理器 (SkillManager)
  - 实现 `loadSkills()` 从目录加载技能文件
  - 实现 `matchSkills()` 根据上下文匹配技能
  - 实现 `applySkills()` 将技能内容应用到系统提示词
  - 实现 `getSkillTools()` 获取技能相关的工具列表
  - 解析技能文件的 YAML frontmatter
  - 支持用户级和项目级技能目录
  - _需求: 8.1, 8.2, 8.3, 8.4, 8.5, 8.6_

- [x] 10.1 为技能管理器编写属性测试
  - **属性 3: 技能匹配的一致性**
  - **验证: 需求 8.2**

### 阶段 7: 扩展系统 - 命令

- [x] 11. 实现命令管理器 (CommandManager)
  - 实现 `loadCommands()` 从目录加载命令文件
  - 实现 `getCommand()` 获取指定命令
  - 实现 `executeCommand()` 执行命令模板
  - 实现参数替换逻辑 ($ARGUMENTS)
  - 实现命令输出嵌入 (!`command`)
  - 实现 `listCommands()` 列出所有命令
  - 支持 /project:command 和 /user:command 命名空间
  - _需求: 9.1, 9.2, 9.3, 9.4, 9.5, 9.6_

- [x] 11.1 为命令管理器编写属性测试
  - **属性 7: 命令参数替换的正确性**
  - **验证: 需求 9.3**

### 阶段 8: 扩展系统 - 子代理

- [x] 12. 实现子代理注册表 (AgentRegistry)
  - 实现 `loadAgents()` 从目录加载代理定义文件
  - 实现 `getAgent()` 获取指定代理
  - 实现 `listAgents()` 列出所有代理
  - 实现 `matchAgent()` 根据任务描述匹配代理
  - 实现 `getAgentsForSDK()` 转换为 SDK 格式
  - 解析代理文件的 YAML frontmatter
  - _需求: 10.1, 10.2, 10.3, 10.4, 10.5, 10.6_

- [x] 12.1 为子代理注册表编写属性测试
  - **属性 8: 子代理上下文的隔离性**
  - **验证: 需求 10.5**

### 阶段 9: 扩展系统 - 钩子

- [x] 13. 实现钩子管理器 (HookManager)
  - 实现 `loadHooks()` 加载钩子配置
  - 实现 `getHooksForSDK()` 转换为 SDK 格式
  - 实现 `executeHooks()` 执行钩子操作
  - 实现 `executeCommand()` 执行命令类型钩子
  - 实现 `executePrompt()` 执行提示词类型钩子
  - 实现 `expandVariables()` 变量替换 ($TOOL, $FILE, $COMMAND)
  - 实现 `addHook()` 和 `removeHook()` 方法
  - 支持所有 12 种钩子事件类型
  - _需求: 11.1, 11.2, 11.3, 11.4, 11.5, 11.6_

- [x] 13.1 为钩子管理器编写属性测试
  - **属性 9: 钩子触发的准确性**
  - **验证: 需求 11.2**

### 阶段 10: MCP 集成

- [x] 14. 实现 MCP 管理器 (MCPManager)
  - 实现 `loadServersFromConfig()` 从 .mcp.json 加载配置
  - 实现 `addServer()` 和 `removeServer()` 方法
  - 实现 `getServersConfig()` 获取所有服务器配置
  - 实现 `listServers()` 列出服务器名称
  - 实现 `validateConfig()` 验证服务器配置
  - 支持 stdio、SSE、HTTP 三种传输类型
  - _需求: 12.1, 12.2, 12.3, 12.4, 12.5, 12.6_

- [x] 14.1 为 MCP 管理器编写属性测试
  - **属性 5: MCP 工具调用的透明性**
  - **验证: 需求 12.3, 12.4**

### 阶段 11: 回退系统

- [x] 15. 实现回退管理器 (RewindManager)
  - 实现 `captureSnapshot()` 捕获文件快照
  - 实现 `restoreSnapshot()` 恢复到指定快照
  - 实现 `listSnapshots()` 列出所有快照
  - 实现快照存储和管理（最多 50 个）
  - 集成到文件修改工具的钩子中
  - _需求: 15.1, 15.2, 15.3, 15.4, 15.5, 15.6_

- [x] 15.1 为回退管理器编写属性测试
  - **属性 6: 回退操作的可逆性**
  - **验证: 需求 15.3**

### 阶段 12: 插件系统

- [ ] 16. 实现插件管理器 (PluginManager)
  - 实现 `installPlugin()` 从不同源安装插件
  - 实现 `uninstallPlugin()` 卸载插件
  - 实现 `listPlugins()` 列出已安装插件
  - 实现 `loadPlugin()` 加载插件内容
  - 支持从本地目录、Git 仓库、插件市场安装
  - 加载插件中的命令、代理、技能、钩子、MCP 服务器
  - _需求: 13.1, 13.2, 13.3, 13.4, 13.5, 13.6_

- [ ] 16.1 为插件管理器编写属性测试
  - **属性 12: 插件加载的完整性**
  - **验证: 需求 13.2**

### 阶段 13: 主程序集成

- [x] 17. 实现主程序入口 (main.ts)
  - 解析命令行参数
  - 初始化配置管理器
  - 创建或恢复会话
  - 根据模式选择交互式或非交互式执行
  - 处理 --help 和 --version 选项
  - 实现错误处理和日志记录
  - _需求: 1.1, 1.2, 1.3, 6.3, 6.4, 20.1, 20.2, 20.3, 20.4, 20.5, 20.6_

- [-] 18. 实现非交互模式处理
  - 实现 -p/--print 模式的单次查询执行
  - 实现输出格式化（text, json, stream-json, markdown）
  - 实现退出码处理
  - 支持通过 stdin 接收输入
  - 支持管道输出
  - _需求: 1.2, 17.1, 17.2, 17.3, 17.4, 17.5, 17.6, 21.5_

- [x] 18.1 为输出格式化编写属性测试
  - **属性 10: 输出格式的一致性**
  - **验证: 需求 17.1, 17.2, 17.3**

### 阶段 14: 高级功能

- [ ] 19. 实现图像支持
  - 实现图像粘贴处理
  - 实现图像文件拖放处理
  - 实现 @./image.png 语法支持
  - 实现图像编码和大小调整
  - 支持 PNG、JPEG、GIF、WebP 格式
  - _需求: 16.1, 16.2, 16.3, 16.4, 16.5, 16.6_

- [ ] 20. 实现上下文管理优化
  - 实现上下文 token 计数
  - 实现历史消息压缩
  - 实现智能文件片段提取
  - 实现对话摘要生成
  - 实现上下文窗口管理
  - _需求: 28.1, 28.2, 28.3, 28.4, 28.5, 28.6_

- [ ] 21. 实现沙箱功能
  - 实现沙箱配置加载
  - 实现命令排除列表检查
  - 实现网络沙箱设置
  - 实现违规检测和处理
  - 集成到 SDK Options 中
  - _需求: 26.2, 26.5_

### 阶段 15: CI/CD 和性能优化

- [ ] 22. 实现 CI/CD 支持
  - 实现 CI 环境检测
  - 实现 API 密钥环境变量支持
  - 实现结构化日志输出
  - 实现超时限制
  - 实现非零退出码返回
  - _需求: 21.1, 21.2, 21.3, 21.4, 21.6_

- [ ] 23. 实现性能优化
  - 实现快速启动（2 秒内初始化）
  - 实现增量加载大型项目
  - 实现项目结构缓存
  - 实现异步 I/O 操作
  - 实现 token 限制管理
  - 实现内存使用监控和清理
  - _需求: 22.1, 22.2, 22.3, 22.4, 22.5, 22.6_

### 阶段 16: 测试框架集成和文档生成

- [ ] 24. 实现测试框架集成
  - 实现测试框架检测（Jest, Pytest, JUnit, Go Test）
  - 实现测试执行命令生成
  - 实现测试输出解析
  - 实现失败测试分析
  - 实现自动测试生成建议
  - 实现覆盖率报告显示
  - _需求: 23.1, 23.2, 23.3, 23.4, 23.5, 23.6_

- [ ] 25. 实现文档生成功能
  - 实现代码变更检测
  - 实现 API 文档生成
  - 实现 README 生成
  - 实现多格式输出（Markdown, HTML, PDF）
  - 实现代码示例提取
  - _需求: 24.1, 24.2, 24.3, 24.4, 24.5, 24.6_

### 阶段 17: 多语言和安全性

- [ ] 26. 实现多语言支持
  - 实现项目语言检测
  - 实现 JavaScript/TypeScript 代码生成策略
  - 实现 Python 代码生成策略
  - 实现 Java 代码生成策略
  - 实现 Go 代码生成策略
  - 根据语言调整最佳实践建议
  - _需求: 25.1, 25.2, 25.3, 25.4, 25.5, 25.6_

- [ ] 27. 实现安全性功能
  - 实现敏感信息检测和警告
  - 实现危险命令确认
  - 实现 API 密钥环境变量处理
  - 实现 HTTPS 加密传输
  - 实现敏感文件黑名单
  - 实现日志脱敏
  - _需求: 26.1, 26.2, 26.3, 26.4, 26.5, 26.6_

### 阶段 18: 协作和扩展性

- [ ] 28. 实现协作功能
  - 实现项目配置共享
  - 实现本地配置覆盖
  - 实现个人认证配置
  - 实现 .gitignore 自动配置
  - 实现配置导出和导入
  - 实现配置验证工具
  - _需求: 29.1, 29.2, 29.3, 29.4, 29.5, 29.6_

- [ ] 29. 实现扩展性架构
  - 实现插件 API 文档
  - 实现自定义工具注册
  - 实现工具参数验证
  - 实现工具错误处理
  - 实现工具钩子点
  - 实现工具异步执行和流式输出
  - _需求: 30.1, 30.2, 30.3, 30.4, 30.5, 30.6_

### 阶段 19: 最终集成和测试

- [ ] 30. 检查点 - 核心功能验证
  - 运行所有单元测试
  - 运行所有属性测试
  - 验证基本 CLI 功能
  - 验证会话管理
  - 验证文件操作和命令执行
  - 询问用户是否有问题

- [ ] 31. 检查点 - 扩展系统验证
  - 验证技能加载和匹配
  - 验证命令执行
  - 验证子代理调用
  - 验证钩子触发
  - 验证 MCP 集成
  - 询问用户是否有问题

- [ ] 32. 检查点 - 高级功能验证
  - 验证回退系统
  - 验证插件系统
  - 验证图像支持
  - 验证沙箱功能
  - 验证性能优化
  - 询问用户是否有问题

- [ ] 33. 端到端集成测试
  - 编写完整工作流的集成测试
  - 测试交互式模式
  - 测试非交互式模式
  - 测试会话恢复
  - 测试错误恢复
  - _需求: 所有需求_

- [ ] 34. 文档和发布准备
  - 编写 README.md
  - 编写 API 文档
  - 编写用户指南
  - 编写开发者指南
  - 配置 npm 发布
  - 创建示例项目
  - _需求: 所有需求_

## 注意事项

- 标记为 `*` 的任务是可选的测试任务，可以根据需要跳过以加快 MVP 开发
- 每个任务都引用了相关的需求编号，便于追溯
- 检查点任务确保增量验证，及时发现问题
- 属性测试验证通用正确性属性，单元测试验证具体示例和边界情况
- 所有测试应该运行至少 100 次迭代（属性测试）
- 优先实现核心功能，然后逐步添加高级功能

## 实现顺序说明

1. **阶段 1-5**: 建立核心基础设施，包括 SDK 集成、会话管理、消息路由
2. **阶段 6-9**: 实现扩展系统（技能、命令、子代理、钩子）
3. **阶段 10-12**: 实现 MCP 集成、回退系统、插件系统
4. **阶段 13**: 集成所有组件到主程序
5. **阶段 14-18**: 实现高级功能和优化
6. **阶段 19**: 最终集成测试和发布准备

每个阶段完成后都有检查点，确保功能正常工作后再继续下一阶段。
