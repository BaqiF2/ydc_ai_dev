[
  {
    "category": "functional",
    "feature": "Token Counting",
    "description": "F-001: 使用分词库精确计算消息列表的 token 总量",
    "overallPass": true,
    "bdd": [
      {
        "scenario": "计算包含纯文本消息的 token 数",
        "description": "对包含 TextBlock 内容的消息列表进行 token 计数",
        "steps": {
          "given": [
            "一个包含 3 条消息的列表",
            "每条消息的 content 为 TextBlock 类型的纯文本"
          ],
          "when": [
            "调用 countTokens 函数"
          ],
          "then": [
            "返回所有消息 token 数的总和",
            "返回值为 number 类型"
          ]
        },
        "passes": true
      },
      {
        "scenario": "计算包含 ToolUseBlock 的 token 数",
        "description": "ToolUseBlock 的 input（JSON 对象）需序列化为字符串后计算 token",
        "steps": {
          "given": [
            "一条 assistant 消息，content 包含一个 ToolUseBlock",
            "ToolUseBlock 的 input 为 JSON 对象 { \"path\": \"/src/index.ts\" }"
          ],
          "when": [
            "调用 countTokens 函数"
          ],
          "then": [
            "ToolUseBlock 的 name、id 和序列化后的 input 文本均被计入 token 总量"
          ]
        },
        "passes": true
      },
      {
        "scenario": "计算包含 ToolResultBlock 的 token 数",
        "description": "ToolResultBlock 的 content 可以是 string 或 ContentBlock[]，需递归计算",
        "steps": {
          "given": [
            "一条 user 消息，content 包含一个 ToolResultBlock",
            "ToolResultBlock 的 content 为嵌套的 ContentBlock 数组"
          ],
          "when": [
            "调用 countTokens 函数"
          ],
          "then": [
            "递归计算所有嵌套 ContentBlock 的 token 数",
            "返回正确的 token 总量"
          ]
        },
        "passes": true
      },
      {
        "scenario": "空消息列表返回 0",
        "description": "当输入为空数组时返回 0 token",
        "steps": {
          "given": [
            "一个空的消息数组 []"
          ],
          "when": [
            "调用 countTokens 函数"
          ],
          "then": [
            "返回 0"
          ]
        },
        "passes": true
      },
      {
        "scenario": "未知 ContentBlock 类型被跳过并记录警告",
        "description": "遇到无法识别的 ContentBlock 类型时，跳过该 block 并记录日志",
        "steps": {
          "given": [
            "一条消息的 content 包含一个未知类型的 ContentBlock",
            "同一消息还包含一个正常的 TextBlock"
          ],
          "when": [
            "调用 countTokens 函数"
          ],
          "then": [
            "未知 block 被跳过，不计入 token",
            "正常 TextBlock 的 token 被正确计算",
            "记录一条警告日志"
          ]
        },
        "passes": true
      },
      {
        "scenario": "空字符串 content 返回 0 token",
        "description": "消息 content 为空字符串时贡献 0 token",
        "steps": {
          "given": [
            "一条消息的 content 为空字符串 \"\""
          ],
          "when": [
            "调用 countTokens 函数"
          ],
          "then": [
            "该消息贡献 0 token",
            "返回值为 0"
          ]
        },
        "passes": true
      }
    ]
  }
]
